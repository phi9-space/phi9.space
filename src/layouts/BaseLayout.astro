---
import SeoHead from '../components/SeoHead.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import AsciiShader from '../components/AsciiShader.astro';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  structuredData?: Record<string, any> | null;
  ogImage?: string;
  pageType?: 'website' | 'article';
}

const {
  title = 'phi9.space',
  description = 'Enabling situational awareness in Physical AI systems.',
  structuredData = null,
  ogImage = '/PHI9.SPACE.svg',
  pageType = 'website'
} = Astro.props as Props;

const hasLeftSlot = Astro.slots.has('left');
---
<html lang="en" data-view-mode="human">
  <head>
    <SeoHead
      title={title}
      description={description}
      ogImage={ogImage}
      pageType={pageType}
      structuredData={structuredData}
    />
    <link
      rel="preload"
      href="/fonts/paper-mono/PaperMono-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
  </head>
  <body>
    <div class="shader-container" aria-hidden="true">
      <AsciiShader />
    </div>
    <header class="top-nav" data-nav>
      <Navbar />
    </header>
    <div class="layout-shell">
      <aside class="layout-rail layout-rail--left">
        <div class="rail-content">
          {hasLeftSlot && <slot name="left" />}
        </div>
      </aside>
      <main class="layout-main">
        <article class="main-article">
          <slot />
        </article>
        <Footer />
      </main>
      <aside class="layout-rail layout-rail--right">
        <slot name="rail" />
      </aside>
    </div>
  </body>
</html>

<style>
  .shader-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -1;
    overflow: hidden;
  }

  .layout-shell {
    display: grid;
    grid-template-columns: minmax(0, 18fr) minmax(0, 64fr) minmax(0, 18fr);
    min-height: 100vh;
    padding: var(--grid-padding);
    gap: clamp(1rem, 2vw, 1.5rem);
    box-sizing: border-box;
    width: 100%;
    max-width: 100vw;
    margin: 0 auto;
    overflow-x: clip;
  }

  .layout-rail {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    position: sticky;
    bottom: var(--grid-padding);
    align-self: flex-end;
    max-height: calc(100vh - var(--grid-padding) * 2);
    box-sizing: border-box;
    width: 100%;
  }

  .layout-rail--right {
    border-left: 1px solid var(--color-border);
    padding-left: clamp(0.75rem, 2vw, 1.25rem);
    color: var(--color-muted);
    gap: 1.5rem;
  }

  .layout-rail--left {
    border-right: 1px solid var(--color-border);
    padding-right: clamp(0.75rem, 2vw, 1.25rem);
  }

  .layout-main {
    display: flex;
    flex-direction: column;
    gap: clamp(3rem, 4vw, 4.5rem);
    box-sizing: border-box;
    width: 100%;
  }

  .main-article {
    position: relative;
    padding: 0;
    box-sizing: border-box;
    width: 100%;
  }

  .rail-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (max-width: 1280px) {
    .layout-shell {
      grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
    }
  }

  @media (max-width: 1024px) {
    .layout-shell {
      grid-template-columns: 1fr;
      gap: clamp(1.5rem, 4vw, 2rem);
      padding: clamp(1.25rem, 5vw, 2rem);
      max-width: 100%;
      overflow: visible;
    }

    .layout-rail {
      position: static;
      max-height: none;
      border: none;
      padding: 0;
    }

    .layout-rail--right {
      order: 3;
      border: none;
      padding: 0;
    }

    .layout-main {
      order: 2;
    }

    .main-article {
      padding: clamp(1.5rem, 3vw, 2.5rem) 0;
    }
  }

  .top-nav {
    position: sticky;
    top: clamp(0.75rem, 2vw, 1.5rem);
    width: min(900px, calc(100% - clamp(2rem, 6vw, 4rem)));
    margin: clamp(1rem, 3vw, 1.4rem) auto 0;
    z-index: 20;
    transition: transform 220ms ease, opacity 220ms ease;
  }

  .top-nav.is-hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-140%);
  }
</style>

<script is:inline>
  const nav = document.querySelector('[data-nav]');
  let previousScrollY = window.scrollY;

  const handleScroll = () => {
    const currentY = window.scrollY;
    if (!nav) return;

    if (currentY > previousScrollY && currentY > 120) {
      nav.classList.add('is-hidden');
    } else {
      nav.classList.remove('is-hidden');
    }

    previousScrollY = currentY;
  };

  window.addEventListener('scroll', handleScroll, { passive: true });
</script>
